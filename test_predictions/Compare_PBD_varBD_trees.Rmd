---
title: "Compare constant-PBD simulated trees with the corresponding variable-BD simulated trees"
output: html_notebook
---

```{r}
library(reticulate)
library(TreeSim)
library(R.utils)
library(geiger)
```

```{r}
np <- import("numpy")
full_results <- np$load("shape_sim_varBD_trees/variable_BDrates.npy", allow_pickle=T)
params <- data.frame(apply(full_results[,5:9], 2, as.numeric))
names(params) <- c("l1","l2","l3","m1","m2")
params
```

```{r}
BD_rtt <- full_results[,10]
plot(BD_rtt[[25]][[2]])
```

## Piecewise-constant simulations

```{r}
sim_tree <- function(RTT){
  tree <- withTimeout(sim.bdsky.stt(n           = 0, 
                                    timestop    = age, 
                                    lambdasky   = rev(RTT[[1]][-1]), 
                                    deathsky    = rev(RTT[[2]][-1]), 
                                    timesky     = c(0, seq(0.01, age, length.out=200)[2:199]), 
                                    sampprobsky = rep(0,199), 
                                    rho         = 1), timeout = 2.0, onTimeout = "warning")
  if (is.numeric(tree) && tree == age){
    branch <- list(edge =  matrix(c(2, 1), ncol = 2), edge.length = age, tip.label = "t1", Nnode = 1, root.edge = 0)
    class(branch) <- "phylo"
    return(branch)
  }
  
  return(tree[[1]])
}

age=15
n_trees=200
sim_BDtrees <- lapply(BD_rtt, function(RTT)lapply(1:n_trees, function(i){
  i <- 0
  while (i<100){
    #print(paste("i=", i))
    tree_left <- sim_tree(RTT)
    if (is.phylo(tree_left)){
      tree_right <- sim_tree(RTT)
      if (is.phylo(tree_right)){
        return(bind.tree(tree_left, tree_right, position=tree_left$root.edge))
      }
    }
    i <- i+1
  }
  return(-1)
}))
```

```{r}
Ntips <- sapply(sim_BDtrees, sapply, function(result)if(is.numeric(result)){NA}else{length(result$tip.label)})
Ntips <- apply(Ntips, 2, as.numeric)
Ntips
```

```{r}
for (i in seq_along(sim_BDtrees)) {
  sim_success <- sapply(sim_BDtrees[[i]], is.phylo)
  if (any(sim_success)){
    write.tree(sim_BDtrees[[i]][sim_success], file=paste0("shape_sim_varBD_trees/sim_varBD_pars", i, ".trees"))
  }
}
```

```{r}
trees_gammma <- sapply(sim_BDtrees, sapply, function(result){
  print(result)
  if (is.numeric(result)){
    return(NaN)
  }else{
    print(result)
    return(ape::gammaStat(result))
    print("\n")
  }
  })
trees_gammma
```

```{r}
trees_stats <- data.frame(param_vary = as.numeric(rep(full_results[,2], each=n_trees)), 
                          i_param_var = as.numeric(rep(full_results[,3], each=n_trees)),
                          replicate = rep(0:(n_trees-1), max(as.numeric(full_results[,2]))*max(as.numeric(full_results[,3]))),
                          gamma = as.numeric(trees_gammma),
                          SR = as.integer(Ntips))
trees_stats
write.csv(trees_stats, "shape_sim_varBD_trees/simulated_varBD_trees_stats.csv")
```



